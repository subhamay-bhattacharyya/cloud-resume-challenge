---
- name: Deploy Cloud Resume Website to Azure
  hosts: localhost
  connection: local
  gather_facts: false

  vars:
    # Default frontend directory - playbook is in frontend/playbooks/azure, so go up 2 levels
    frontend_dir: "{{ playbook_dir }}/../../"
    build_dir: "{{ frontend_dir }}/dist"

  tasks:
    # =========================================
    # Display Deployment Information
    # =========================================
    - name: Print deployment info as JSON string
      ansible.builtin.debug:
        msg: >
          {
            'playbook': '{{ playbook_dir }}',
            'frontend_directory': '{{ frontend_dir }}',
            'playbook_directory': '{{ playbook_dir }}',
            'Azure Storage Account': '{{ storage_account_name }}'
          }

    # =========================================
    # Validate Required Inputs
    # =========================================
    - name: Validate required inputs are provided
      ansible.builtin.assert:
        that:
          - storage_account_name is defined
          - storage_account_name != ""
        fail_msg: >
          Required inputs missing.
          Ensure storage_account_name is passed as JSON via --extra-vars.

    # =========================================
    # Build Frontend
    # =========================================
    - name: Install Node dependencies (clean, reproducible)
      community.general.npm:
        path: "{{ frontend_dir }}"
        state: present
        production: false
        ci: true

    - name: Build Vite app for Azure
      ansible.builtin.shell: npm run build_azure
      args:
        chdir: "{{ frontend_dir }}"
      register: build_result

    - name: Display build output
      ansible.builtin.debug:
        msg: "{{ build_result.stdout_lines }}"

    - name: Confirm build dir exists
      ansible.builtin.stat:
        path: "{{ build_dir }}"
      register: build_stat

    - name: Fail if build output missing
      ansible.builtin.fail:
        msg: "Build dir {{ build_dir }} not found. Check build step or paths."
      when: not build_stat.stat.exists

    # =========================================
    # Upload to Azure Blob Storage
    # =========================================
    - name: Install Azure CLI
      ansible.builtin.shell: |
        if ! command -v az &> /dev/null; then
          curl -sL https://aka.ms/InstallAzureCLIDeb | sudo bash
        fi
        az --version
      args:
        executable: /bin/bash
      register: az_install
      changed_when: "'already installed' not in az_install.stdout"

    - name: Upload files to Azure Blob Storage with az CLI
      ansible.builtin.shell: |
        # Determine content type
        case "{{ item.path }}" in
          *.html) CONTENT_TYPE="text/html" ;;
          *.css) CONTENT_TYPE="text/css" ;;
          *.js) CONTENT_TYPE="application/javascript" ;;
          *.json) CONTENT_TYPE="application/json" ;;
          *.webp) CONTENT_TYPE="image/webp" ;;
          *.png) CONTENT_TYPE="image/png" ;;
          *.jpg|*.jpeg) CONTENT_TYPE="image/jpeg" ;;
          *.svg) CONTENT_TYPE="image/svg+xml" ;;
          *.ico) CONTENT_TYPE="image/x-icon" ;;
          *.woff) CONTENT_TYPE="font/woff" ;;
          *.woff2) CONTENT_TYPE="font/woff2" ;;
          *.ttf) CONTENT_TYPE="font/ttf" ;;
          *) CONTENT_TYPE="application/octet-stream" ;;
        esac
        
        az storage blob upload \
          --account-name "{{ storage_account_name }}" \
          --container-name "\$web" \
          --name "{{ item.path }}" \
          --file "{{ item.src }}" \
          --content-type "$CONTENT_TYPE" \
          --content-cache-control "public, max-age=31536000" \
          --auth-mode login \
          --overwrite
      args:
        executable: /bin/bash
      with_filetree: "{{ build_dir }}"
      when: item.state == 'file'
      register: upload_result

    - name: Display upload results
      ansible.builtin.debug:
        msg: |
          ðŸ“¤ Azure Blob Storage Upload Results:
          Files processed: {{ upload_result.results | default([]) | length }}
          Storage Account: {{ storage_account_name }}
          Container: $web


