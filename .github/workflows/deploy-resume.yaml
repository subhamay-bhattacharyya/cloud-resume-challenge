name: Deploy Cloud Resume Website
run-name: >
  Deploy resume to ${{ github.event.inputs['cloud-provider'] }} by ${{ github.actor }} on ${{ github.ref_name }}

on:
  workflow_dispatch:
    inputs:
      cloud-provider:
        description: "Choose the cloud provider"
        required: true
        type: choice
        options:
          - aws
          - gcp
          - azure
        default: aws
      s3-bucket-name:
        description: "AWS Target S3 bucket"
        required: false
        type: string
        default: "subhamay-crc-website"
      cloudfront-distribution-id:
        description: "AWS CloudFront distribution ID"
        required: false
        type: string
        default: "EW4CNVNO57XTH"
      google-cloud-storage-bucket:
        description: "Google Cloud Storage bucket name"
        required: false
        type: string
        default: "subhamay-crc-website"
      azure-storage-account-name:
        description: "Azure Storage account name"
        required: false
        type: string
        default: "subhamaycrcoxv15o"

jobs:
  prepare-vars:
    name: Prepare Ansible Variables
    runs-on: ubuntu-latest
    outputs:
      ansible-extra-vars: ${{ steps.set-vars.outputs.ansible-extra-vars }}
    steps:
      - name: Set Ansible extra vars based on cloud provider
        id: set-vars
        run: |
          case "${{ inputs.cloud-provider }}" in
            aws)
              EXTRA_VARS=$(cat <<EOF
          {
            "s3_bucket_name": "${{ inputs.s3-bucket-name }}",
            "cloudfront_distribution_id": "${{ inputs.cloudfront-distribution-id }}"
          }
          EOF
              )
              ;;
            gcp)
              EXTRA_VARS=$(cat <<EOF
          {
            "gcs_bucket_name": "${{ inputs.google-cloud-storage-bucket }}"
          }
          EOF
              )
              ;;
            azure)
              EXTRA_VARS=$(cat <<EOF
          {
            "storage_account_name": "${{ inputs.azure-storage-account-name }}"
          }
          EOF
              )
              ;;
            *)
              echo "Unknown cloud provider: ${{ inputs.cloud-provider }}"
              exit 1
              ;;
          esac
          
          # Remove newlines and extra spaces for output
          EXTRA_VARS=$(echo "$EXTRA_VARS" | jq -c .)
          echo "ansible-extra-vars=$EXTRA_VARS" >> $GITHUB_OUTPUT
          
          echo "::notice::Prepared Ansible vars for ${{ inputs.cloud-provider }}: $EXTRA_VARS"

  aws:
    if : github.event.inputs['cloud-provider'] == 'aws'
    needs: prepare-vars
    uses: subhamay-bhattacharyya-gha/run-ansible-playbook-wf/.github/workflows/run-ansible-playbook.yaml@feature/GHA-0006-add-step-to-run-ansible-p
    with:
      cloud-provider: "aws"
      aws-region: "${{ vars.AWS_REGION || 'us-east-1' }}"
      ansible-playbook-path: "frontend/playbooks/${{ inputs.cloud-provider }}/deploy-resume.yaml"
      ansible-extra-vars: ${{ needs.prepare-vars.outputs.ansible-extra-vars }}
    secrets:
      aws-role-to-assume: ${{ secrets.AWS_OIDC_ROLE_ARN }}

  gcp:
    if: github.event.inputs['cloud-provider'] == 'gcp'
    needs: prepare-vars
    uses: subhamay-bhattacharyya-gha/run-ansible-playbook-wf/.github/workflows/run-ansible-playbook.yaml@feature/GHA-0006-add-step-to-run-ansible-p
    with:
      cloud-provider: "gcp"
      gcp-region: "${{ vars.GCP_REGION || 'us-central1' }}"
      ansible-playbook-path: "frontend/playbooks/${{ inputs.cloud-provider }}/deploy-resume.yaml"
      ansible-extra-vars: ${{ needs.prepare-vars.outputs.ansible-extra-vars }}
    secrets:
      gcp-workload-identity-provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
      gcp-service-account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

  azure:
    if: github.event.inputs['cloud-provider'] == 'azure'
    needs: prepare-vars
    uses: subhamay-bhattacharyya-gha/run-ansible-playbook-wf/.github/workflows/run-ansible-playbook.yaml@feature/GHA-0006-add-step-to-run-ansible-p
    with:
      cloud-provider: "azure"
      azure-region: "${{ vars.AZURE_REGION || 'eastus' }}"
      ansible-playbook-path: "frontend/playbooks/${{ inputs.cloud-provider }}/deploy-resume.yaml"
      ansible-extra-vars: ${{ needs.prepare-vars.outputs.ansible-extra-vars }}
    secrets:
      azure-client-id: ${{ secrets.AZURE_CLIENT_ID }}
      azure-tenant-id: ${{ secrets.AZURE_TENANT_ID }}
      azure-subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
